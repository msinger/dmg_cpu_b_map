<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%;">
<head>
<meta charset="UTF-8">
<title>DMG-CPU B Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="leaflet.css">
<link rel="stylesheet" href="Control.MiniMap.css">
<script src="leaflet.js"></script>
<script src="Control.MiniMap.js"></script>
<script src="coords.js"></script>
</head>
<body style="width: 100%; height: 100%; margin: 0px;">
<div id="map" style="width: 100%; height: 100%;"></div>
<script>

	var params = new URLSearchParams(document.location.search.substring(1));

	var digshadowAtr = "CC-BY-4.0 digshadow/<a href=\"https://siliconpr0n.org/map/nintendo/dmg-cpu-b/\">siliconpr0n.org</a>";
	var siliconpr0nAtr = "CC-BY-4.0 <a href=\"https://siliconpr0n.org/map/nintendo/dmg-cpu-b/\">siliconpr0n.org</a>";
	var furrtekAtr = "CC-BY-SA-4.0 <a href=\"https://github.com/furrtek/DMG-CPU-Inside\">Furrtek</a> &amp; <a href=\"https://github.com/msinger/dmg-schematics\">Règis Galland &amp; Michael Singer</a>";
	var iceboyAtr = "CC-BY-SA-4.0 <a href=\"https://github.com/msinger/dmg-schematics\">Règis Galland &amp; Michael Singer</a>";

	var tl_die_mz_20x = L.tileLayer('map/die_mz_20x/{z}/{y}/{x}.jpg', {
		attribution: digshadowAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_die_s1_1_20x = L.tileLayer('map/die_s1_1_20x/{z}/{y}/{x}.jpg', {
		attribution: siliconpr0nAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_die_mz_20x_minimap = L.tileLayer('map/die_mz_20x/{z}/{y}/{x}.jpg', {
		attribution: digshadowAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_die_s1_1_20x_minimap = L.tileLayer('map/die_s1_1_20x/{z}/{y}/{x}.jpg', {
		attribution: siliconpr0nAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_cells = L.tileLayer('map/cells/{z}/{y}/{x}.png', {
		attribution: furrtekAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_wires = L.tileLayer('map/wires/{z}/{y}/{x}.png', {
		attribution: furrtekAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_labels = L.tileLayer('map/labels/{z}/{y}/{x}.png', {
		attribution: furrtekAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_cells_new = L.tileLayer('map/cells_new/{z}/{y}/{x}.png', {
		attribution: iceboyAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_wires_new = L.tileLayer('map/wires_new/{z}/{y}/{x}.png', {
		attribution: iceboyAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var tl_labels_new = L.tileLayer('map/labels_new/{z}/{y}/{x}.png', {
		attribution: iceboyAtr,
		maxNativeZoom: 6,
		tileSize: 256,
		noWrap: true,
		bounds: [[-256, 0], [0, 256]]
	});

	var baseMaps = {
		"DMG-CPU B: MZ 20x": tl_die_mz_20x,
		"DMG-CPU B: S1-1 20x": tl_die_s1_1_20x
	};

	var baseMapsMini = {
		"DMG-CPU B: MZ 20x": tl_die_mz_20x_minimap,
		"DMG-CPU B: S1-1 20x": tl_die_s1_1_20x_minimap
	};

	var overlayMaps = {
		"Cells": tl_cells,
		"Wires": tl_wires,
		"Labels": tl_labels,
		"Cells [new-testing]": tl_cells_new,
		"Wires [new-testing]": tl_wires_new,
		"Labels [new-testing]": tl_labels_new
	};

	var shotp   = params.get("shot");
	var cellsp  = params.get("cells");
	var wiresp  = params.get("wires");
	var labelsp = params.get("labels");
	var def_layers = [tl_die_mz_20x];
	if (shotp   == "1") def_layers = [tl_die_s1_1_20x];
	if (cellsp  != "0") def_layers.push(tl_cells);
	if (wiresp  != "0") def_layers.push(tl_wires);
	if (labelsp != "0") def_layers.push(tl_labels);

	var map = L.map('map', {
		crs: L.CRS.Simple,
		center: [-128, 128],
		zoom: 1,
		minZoom: 0,
		maxZoom: 7,
		zoomSnap: 1,
		zoomDelta: 1,
		layers: def_layers,
		maxBounds: [[-512, -256], [256, 512]]
	});

	L.control.layers(baseMaps, overlayMaps).addTo(map);

	var topWhiteRows = 22;

	var miniMap = new L.Control.MiniMap(tl_die_mz_20x_minimap, {
		zoomLevelFixed: 0,
		toggleDisplay: true,
		centerFixed: [-128 - topWhiteRows / 2, 128],
		width: 256,
		height: 256 - topWhiteRows,
		mapOptions: {
			doubleClickZoom: false,
			dragging: false,
			scrollWheelZoom: false,
			touchZoom: false,
			maxZoom: 0
		}
	}).addTo(map);

	map.on('baselayerchange', function (e) {
		miniMap.changeLayer(baseMapsMini[e.name]);
	});

	var paramDraw = params.get("draw") != null;
	if (paramDraw) {
		var dline = [];
		var dlinePoly = null;
		var lineEditBox = L.control({ position: 'bottomleft' });
		var lineEdit = document.createElement('input');
		lineEdit.type = "text";
		lineEdit.onkeydown = function (e) {
			if (e.key == 'Enter') {
				var coords = this.value;
				dline = [];
				if (coords) {
					var p = coords.split(",");
					if (p.length >= 4 && !(p.length & 1)) {
						for (var i = 0; i < p.length; i += 2)
							dline[i/2] = [p[i], p[i+1]];
					}
				}
				if (dlinePoly)
					dlinePoly.removeFrom(map);
				dlinePoly = null;
				if (dline.length > 1)
					dlinePoly = L.polyline(dline, { color: 'green' }).addTo(map);
			}
		};

		lineEditBox.onAdd = function (map) {
			var div = L.DomUtil.create('div', 'leaflet-control-attribution');
			var p = document.createElement('p');
			p.appendChild(lineEdit);
			div.appendChild(p);
			return div;
		};

		lineEditBox.addTo(map);

		map.on('click', function (e) {
			if (!window.event.ctrlKey) return;
			var lat = e.latlng.lat.toFixed(2);
			var lng = e.latlng.lng.toFixed(2);
			if (window.event.shiftKey && dline.length >= 1) {
				var dlat = Math.abs(lat - dline[dline.length - 1][0]);
				var dlng = Math.abs(lng - dline[dline.length - 1][1]);
				if (dlat < dlng)
					lat = dline[dline.length - 1][0];
				else
					lng = dline[dline.length - 1][1];
			}
			dline[dline.length] = [lat, lng];
			var t = "";
			for (var i = 0; i < dline.length; i++) {
				if (i > 0)
					t += ",";
				t += dline[i][0] + "," + dline[i][1];
			}
			lineEdit.value = t;
			if (dlinePoly)
				dlinePoly.removeFrom(map);
			dlinePoly = null;
			if (dline.length > 1)
				dlinePoly = L.polyline(dline, { color: 'green' }).addTo(map);
		});
	}

	function find_grp(n, t = "") {
		var cgrp = null;
		var wgrp = null;
		if (t != "w")
			cgrp = cells_grp[n.trim().toLowerCase()];
		if (t != "c")
			wgrp = wires_grp[n.trim().toLowerCase()];
		var ret = [];
		if (cgrp)
			for (var x of cgrp)
				ret.push({ t: "c", i: cells_cn[x] });
		if (wgrp)
			for (var x of wgrp)
				ret.push({ t: "w", i: wires_cn[x] });
		return ret;
	}

	var src = L.control({ position: 'bottomleft' });
	var cellSearch = document.createElement('input');
	cellSearch.type = "text";
	cellSearch.onkeydown = function (e) {
		if (e.key == 'Enter') {
			var res = find_grp(this.value, "c");
			if (res.length == 1)
				map.fitBounds([[res[0].i.l[0], res[0].i.l[1]], [res[0].i.l[2], res[0].i.l[3]]]);
			this.setSelectionRange(0, this.value.length);
		}
	};

	src.onAdd = function (map) {
		var div = L.DomUtil.create('div', 'leaflet-control-attribution');
		var p = document.createElement('p');
		p.appendChild(cellSearch);
		div.appendChild(p);
		var p = document.createElement('p');
		p.innerHTML = "<a href=\"https://github.com/msinger/dmg_cpu_b_map/\">Source code on GitHub</a>";
		div.appendChild(p);
		return div;
	};

	src.addTo(map);

	var coord = L.control({ position: 'bottomleft' });
	var coordDiv = L.DomUtil.create('div', 'leaflet-control-attribution');
	coordDiv.innerHTML = "<p>&nbsp;</p>";
	coord.onAdd = function (map) { return coordDiv; };
	coord.addTo(map);

	map.on('mousemove', function (e) {
		coordDiv.innerHTML = "<p>" + e.latlng.lat.toFixed(2) + ", " + e.latlng.lng.toFixed(2) + "</p>";
	});

	var line = [];
	for (var i = 0; i < 512; i++) {
		var l = params.get("line[" + i + "]");
		if (l) {
			var p = l.split(",");
			if (p.length >= 4 && !(p.length & 1)) {
				line[i] = [];
				for (var j = 0; j < p.length; j += 2)
					line[i][j/2] = [p[j], p[j+1]];
			}
		}
	}

	var mark = [];
	for (var i = 0; i < 512; i++) {
		var m = params.get("mark[" + i + "]");
		if (m) {
			var p = m.split(",");
			var s = '';
			if (p.length == 3) {
				s = p[2];
				p = [p[0], p[1]];
			}
			if (p.length == 2) {
				mark[i] = { p: p, s: s };
			}
		}
	}

	if (line.length > 0) {
		var b = L.polyline(line, { color: 'red' }).addTo(map).getBounds();
		L.polyline(line, { color: 'red' }).addTo(miniMap._miniMap);
	}

	for (var m of mark) {
		L.marker(m.p, { title: m.s }).addTo(map);
		L.marker(m.p, { title: m.s }).addTo(miniMap._miniMap);
	}

	var view = params.get("view");
	if (view) {
		var p = view.split(",");
		var z = 6;
		if (p.length == 1) {
			var res = find_grp(p[0], "c");
			if (res.length >= 1)
				p = [res[0].i.l[0], res[0].i.l[1], res[0].i.l[2], res[0].i.l[3]];
		}
		if (p.length == 4)
			map.fitBounds([[p[0], p[1]], [p[2], p[3]]]);
		if (p.length == 3) {
			z = p[2];
			p = [p[0], p[1]];
		}
		if (p.length == 2)
			map.setView(p, z);
	}

	document.getElementById('map').style.cursor = 'crosshair'

</script>
</body>
</html>
